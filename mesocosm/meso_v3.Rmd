```{r}
# Load required libraries
library(dplyr)
library(tidyverse)
library(janitor)
library(ggplot2)
library(readxl)
library(lme4)
library(ggpubr)

# Load data
meso<- read.csv("mill_mesocosm_full_data4_long.csv") %>% 
  clean_names()
meta <- read.csv("mesocosm_meta.csv")

```
`

```{r}
library(dplyr)
library(janitor)

# read + clean names only
meta <- read.csv("mesocosm_meta.csv") %>% clean_names()
dat  <- read.csv("mill_mesocosm_full_data4_long.csv") %>% clean_names()


```

```{r}
library(dplyr)

# Read your data
df1 <- read.csv("mill_mesocosm_full_data4_long.csv")
df2 <- read.csv("mesocosm_meta.csv")
result <- df2 %>%
  full_join(df1, by = ("seaweed_id"))

result <- result %>% 
  clean_names()
```

```{r}
meso <- read.csv("mesocosm_complete.csv")

#write.csv(result, "mesocosm_complete.csv")

meso <- meso %>% 
  mutate(colony_length_max = as.numeric(colony_length_max))

```


```{r}
juvenile<- meso %>%
  filter(grepl("juvenile", age)) %>% 
  group_by(seaweed_id, epibiont_sampling_date) %>% 
  filter(!is.na(turbulence),
       turbulence != "",
         species %in% c("Membranipora", "Pilosa")) %>%
  mutate(
    nutrient_treatment = factor(nutrient_treatment,
                                levels = c("C", "N", "P")),
    epibiont_sampling_date = factor(epibiont_sampling_date,
                          levels = c("04/06/2025", "12/06/2025", "02/07/2025"))
  )

juvenile %>% 
  ggplot(aes(x = nutrient_treatment, y = colony_area, colour = turbulence)) +
  geom_boxplot() +
  facet_grid(species ~ epibiont_sampling_date) +
  labs(y = "Colony area (cm²)",
       x = "Nutrient Treatment",
       colour = "Turbulence")
```

```{r}
juvenile %>% 
  ggplot(aes(x = nutrient_treatment, y = colony_length_max, color = turbulence)) +
  geom_boxplot() +
  facet_grid(species ~ epibiont_sampling_date) +
  labs(y = "Colony length (cm)",
       x = "Nutrient Treatment",
       colour = "Turbulence")
```

```{r}
adult<- meso %>%
  filter(grepl("adult", age)) %>% 
  group_by(seaweed_id, epibiont_sampling_date) %>% 
  filter(!is.na(turbulence),
       turbulence != "",
         species %in% c("Membranipora", "Pilosa")) %>%
  mutate(
    nutrient_treatment = factor(nutrient_treatment,
                                levels = c("C", "N", "P")),
    epibiont_sampling_date = factor(epibiont_sampling_date,
                          levels = c("04/06/2025", "12/06/2025", "02/07/2025"))
  )
```

```{r}
adult %>% 
  ggplot(aes(x = nutrient_treatment, y = colony_area, color = turbulence)) +
  geom_boxplot() +
  facet_grid(species~ epibiont_sampling_date) +
  labs(y = "Colony area (cm²)",
       x = "Nutrient Treatment",
       colour = "Turbulence") +
  theme_minimal()
```

```{r}
adult %>% 
  group_by(species, epibiont_sampling_date, nutrient_treatment, turbulence) %>%
  summarise(
    mean_length = mean(colony_length_max, na.rm = TRUE),
    se_length = sd(colony_length_max, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = nutrient_treatment, y = mean_length, fill = turbulence)) +
  geom_col(position = position_dodge(0.9)) +
  geom_errorbar(
    aes(ymin = mean_length - se_length, ymax = mean_length + se_length),
    position = position_dodge(0.9),
    width = 0.25
  ) +
  facet_grid(species ~ epibiont_sampling_date) +
  labs(y = "Colony max length (cm)",
       x = "Nutrient Treatment",
       fill = "Turbulence",
       title = "colony lenght max std error") +
  theme_minimal()
```


```{r}
adult %>% 
  ggplot(aes(x = nutrient_treatment, y = colony_length_max, colour = turbulence)) +
  geom_boxplot() +
  facet_grid(species ~ epibiont_sampling_date) +
  labs(y = "Colony max length (cm)",
       x = "Nutrient Treatment",
       colour = "Turbulence") +
  theme_minimal()
```


Colony length max with standard deviation

```{r}
adult %>% 
  group_by(species, epibiont_sampling_date, nutrient_treatment, turbulence) %>%
  summarise(
    mean_length = mean(colony_length_max, na.rm = TRUE),
    sd_length = sd(colony_length_max, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes(x = nutrient_treatment, y = mean_length, fill = turbulence)) +
  geom_col(position = position_dodge(0.9)) +
  geom_errorbar(
    aes(ymin = mean_length - sd_length, ymax = mean_length + sd_length),
    position = position_dodge(0.9),
    width = 0.25
  ) +
  facet_grid(species ~ epibiont_sampling_date) +
  labs(y = "Colony max length (cm)",
       x = "Nutrient Treatment",
       fill = "Turbulence",
       title = "std deviation") +
  theme_minimal()
```

```{r}

# Kruskal-Wallis tests for colony_length_max - data deemed non-normal

# 1. Overall test by nutrient treatment (ignoring other factors)
kruskal.test(colony_length_max ~ nutrient_treatment, data = adult)

# 2. Separate tests for each species
## M. membranacea
adult %>%
  filter(species == "Membranipora") %>%
  kruskal.test(colony_length_max ~ nutrient_treatment, data = .)

## E. pilosa
adult %>%
  filter(species == "Pilosa") %>%
  kruskal.test(colony_length_max ~ nutrient_treatment, data = .)

# 3. Tests for each combination of species × turbulence × date
library(tidyr)

results <- adult %>%
  group_by(species, turbulence, epibiont_sampling_date) %>%
  summarise(
    n = n(),
    kruskal_p = if(n() > 5 && length(unique(nutrient_treatment)) > 1) {
      kruskal.test(colony_length_max ~ nutrient_treatment)$p.value
    } else {
      NA
    },
    .groups = "drop"
  )

print(results)

# 4. Post-hoc pairwise comparisons (if Kruskal is significant)
library(FSA)

# For M. membranacea only (since E. pilosa has low n)
memb_data <- adult %>% filter(species == "Membranipora")

# Overall post-hoc
dunnTest(colony_length_max ~ nutrient_treatment, 
         data = memb_data, 
         method = "bonferroni")

# 5. By turbulence and date for M. membranacea
## High turbulence, 04/06/2025
memb_data %>%
  filter(turbulence == "High", epibiont_sampling_date == "04/06/2025") %>%
  dunnTest(colony_length_max ~ nutrient_treatment, 
           data = ., 
           method = "bonferroni")

## High turbulence, 12/06/2025
memb_data %>%
  filter(turbulence == "High", epibiont_sampling_date == "12/06/2025") %>%
  dunnTest(colony_length_max ~ nutrient_treatment, 
           data = ., 
           method = "bonferroni")

## Low turbulence, 04/06/2025
memb_data %>%
  filter(turbulence == "Low", epibiont_sampling_date == "04/06/2025") %>%
  dunnTest(colony_length_max ~ nutrient_treatment, 
           data = ., 
           method = "bonferroni")

## Low turbulence, 12/06/2025
memb_data %>%
  filter(turbulence == "Low", epibiont_sampling_date == "12/06/2025") %>%
  dunnTest(colony_length_max ~ nutrient_treatment, 
           data = ., 
           method = "bonferroni")

# 6. Alternative: More comprehensive approach with results table
library(rstatix)

stat_results <- adult %>%
  group_by(species, turbulence, epibiont_sampling_date) %>%
  kruskal_test(colony_length_max ~ nutrient_treatment) %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_significance("p.adj")

print(stat_results)

# Post-hoc for significant results
posthoc_results <- adult %>%
  filter(species == "Membranipora") %>%
  group_by(turbulence, epibiont_sampling_date) %>%
  dunn_test(colony_length_max ~ nutrient_treatment, p.adjust.method = "bonferroni")

print(posthoc_results)
```

```{r}
posthoc_results_hydro <- adult_hydro %>%
  filter(species == "Hydrozoa") %>%
  group_by(turbulence, epibiont_sampling_date) %>%
  dunn_test(hydrozoan_count ~ nutrient_treatment, p.adjust.method = "bonferroni")

posthoc_results_hydro
```



```{r}
adult_hydro<- meso %>%
  filter(grepl("adult", age)) %>% 
  group_by(seaweed_id, epibiont_sampling_date) %>% 
  filter(species == "Hydrozoa") %>%
  mutate(
    nutrient_treatment = factor(nutrient_treatment,
                                levels = c("C", "N", "P")),
    epibiont_sampling_date = factor(epibiont_sampling_date,
                          levels = c("04/06/2025", "12/06/2025", "02/07/2025")))
```

```{r}
adult_hydro%>% 
  ggplot(aes(x = nutrient_treatment, y = hydrozoan_count, color = turbulence)) +
  geom_boxplot() +
  facet_grid(species~ epibiont_sampling_date) +
  labs(y = "No. hydrozoan individ.",
       x = "Nutrient Treatment",
       colour = "Turbulence") +
  theme_minimal()
```

```{r}
results_hydro <- adult_hydro %>%
  group_by(species, turbulence, epibiont_sampling_date) %>%
  summarise(
    n = n(),
    kruskal_p = if(n() > 5 && length(unique(nutrient_treatment)) > 1) {
      kruskal.test(hydrozoan_count ~ nutrient_treatment)$p.value
    } else {
      NA
    },
    .groups = "drop"
  )

print(results_hydro)
```


```{r}
# All pairwise comparisons
hydro_stats_all <- adult_hydro %>%
  unite("treatment_combo", nutrient_treatment, turbulence, remove = FALSE) %>%
  group_by(species, epibiont_sampling_date) %>%
  wilcox_test(hydrozoan_count ~ treatment_combo) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance("p.adj")

# View results
hydro_stats_all
```
```{r}
adult_spiro <- meso %>%
  filter(grepl("adult", age)) %>% 
  group_by(seaweed_id, epibiont_sampling_date) %>% 
  filter(species == "Spirobranchus") %>%
  mutate(
    nutrient_treatment = factor(nutrient_treatment,
                                levels = c("C", "N", "P")),
    epibiont_sampling_date = factor(epibiont_sampling_date,
                          levels = c("04/06/2025", "12/06/2025", "02/07/2025")))
```

```{r}
adult_spiro %>% 
  ggplot(aes(x = nutrient_treatment, y = spirobranchus_count, color = turbulence)) +
  geom_boxplot() +
  facet_grid(species~ epibiont_sampling_date) +
  labs(y = "No. hydrozoan individ.",
       x = "Nutrient Treatment",
       colour = "Turbulence") +
  theme_minimal()
```


```{r}
# All pairwise comparisons
spiro_stats_all <- adult_spiro %>%
  unite("treatment_combo", nutrient_treatment, turbulence, remove = FALSE) %>%
  group_by(species, epibiont_sampling_date) %>%
  wilcox_test(spirobranchus_count ~ treatment_combo) %>%
  adjust_pvalue(method = "BH") %>%
  add_significance("p.adj")

# View results
spiro_stats_all
```

