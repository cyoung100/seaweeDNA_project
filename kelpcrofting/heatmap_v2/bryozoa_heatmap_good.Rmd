---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r}
# Load necessary packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(janitor)
library(stringr)
library(viridis)
library(scales)
library(lubridate)
library(ComplexHeatmap)
library(circlize)
library(viridis)
library(tidyverse)
getwd()
bryozoa <- read.csv("bryozoa_heatmap.csv", fileEncoding = "latin1")
bryozoa <- clean_names(bryozoa) %>%
  filter(site != "Scalpay",
         seaweed != "Alaria") %>%
  select(-total_area)

```



```{r}
bryozoa_long <- bryozoa %>%
  pivot_longer(
    cols = -c(sample_code, date, station_no, seaweed, site, day, month, year),
    names_to = "species_id",
    values_to = "measurement_value"
  ) %>%
  mutate(
    measurement_type = case_when(
      str_detect(species_id, "^otu_") ~ "otu",
      str_detect(species_id, "plankton") ~ "abundance",
      str_detect(species_id, "percent_blade") ~ "blade_coverage",
      TRUE ~ NA_character_
    ),
    measurement_origin = case_when(
      measurement_type == "otu" ~ "Plankton eDNA (RSV)",
      measurement_type == "abundance" ~ "Plankton Abundance (cell/L)",
      species_id == "saccharina_percent_blade_bryozoans" ~ "Bryozoan Blade Coverage - Saccharina (%)",
    #  species_id == "alaria_percent_blade_bryozoans"     ~ "Bryozoan Blade Coverage - Alaria (%)",
      TRUE ~ "Bryozoan Blade Coverage (%)"
    ),
    parsed_date = make_date(day, month, year)
  )

bryozoa_long_log <- bryozoa_long %>%
 mutate(
  measurement_value = case_when(
   measurement_origin == "Plankton eDNA (RSV)" ~ log1p(measurement_value),  # log1p avoids log(0)
    TRUE ~ measurement_value  # keep other values unchanged
  )
)


```


```{r}
library(forcats)
library(dplyr)
library(lubridate)

bryozoa_heatmap <- bryozoa_long_log %>%
  mutate(
    parsed_date = dmy(date),
    station = paste0("st", station_no),
    sample_order = paste(parsed_date, station_no, sep = "_"),
    origin_label = factor(measurement_origin, levels = c(
      "Plankton eDNA (RSV)",
      "Plankton Abundance (cell/L)",
      "Bryozoan Blade Coverage - Saccharina (%)"#,
     # "Bryozoan Blade Coverage - Alaria (%)"
    )),
    y_axis = case_when(
      measurement_origin == "Plankton eDNA (RSV)" ~ paste("RSV", species_id),
      TRUE ~ measurement_origin
    ),
    y_axis = factor(
      y_axis,
      levels = c(
        "RSV otu_membranipora_membranacea",
        "RSV otu_electra_pilosa",
        "RSV otu_celleporella_hyalina",
        "Plankton Abundance (cell/L)",
        "Bryozoan Blade Coverage - Saccharina (%)"#,
     # "Bryozoan Blade Coverage - Alaria (%)"
      )
    ),
    y_axis = fct_recode(y_axis,
      "Membranipora\n membranacea (RSV)" = "RSV otu_membranipora_membranacea",
      "Electra pilosa (RSV)"           = "RSV otu_electra_pilosa",
      "Celleporella\n hyalina (RSV)"     = "RSV otu_celleporella_hyalina",
      "Bryozoan Plankton\n Abundance (cell/L)" = "Plankton Abundance (cell/L)",
      "Bryozoan Blade Coverage \n Saccharina (%)"       = "Bryozoan Blade Coverage - Saccharina (%)"#,
   #  "Bryozoan Blade Coverage \n Alaria (%)"           = "Bryozoan Blade Coverage - Alaria (%)"
    )
  )



```

```{r}
# Deduplicate
bryozoa_cleaned <- bryozoa_heatmap %>%
    filter(!species_id == "alaria_percent_blade_bryozoans") %>% 
  group_by(y_axis, sample_order) %>%
  summarise(measurement_value = mean(measurement_value, na.rm = TRUE), .groups = "drop")


# Matrix and scale
bryozoa_mat <- bryozoa_cleaned %>%
  pivot_wider(names_from = sample_order, values_from = measurement_value, values_fill = NA) %>%
  column_to_rownames("y_axis") %>%
  as.matrix()

```

```{r}
# Color scale using viridis magma
viridis_magma <- viridis(100, option = "M")
value_range <- range(bryozoa_mat, na.rm = TRUE)
col_fun <- colorRamp2(seq(value_range[1], value_range[2], length.out = 100), viridis_magma)
```

```{r}
# Extract metadata from column names
col_meta <- strsplit(colnames(bryozoa_mat), "_")
dates <- sapply(col_meta, `[`, 1)
stations <- paste0("S", sapply(col_meta, `[`, 2))  # Add S prefix

# Format dates
formatted_dates <- format(as.Date(dates), "%d %b")

# Blank out most dates (e.g., every 3rd one only)
sparse_date_labels <- rep("", length(formatted_dates))
sparse_date_labels[seq(2, length(formatted_dates), by = 3)] <- formatted_dates[seq(2, length(formatted_dates), by = 3)]

# Create annotations
top_anno <- HeatmapAnnotation(
  Station = anno_text(stations, rot = 0,  just = "center", gp = gpar(fontsize = 10)),
  annotation_name_side = "left",
  annotation_height = unit(0.6, "lines"),
  which = "column"
)

bottom_anno <- HeatmapAnnotation(
  Date = anno_text(sparse_date_labels, rot = 0,  just = c("top", "right"), gp = gpar(fontsize =10)),
  annotation_name_side = "left",
  annotation_height = unit(1, "lines"),
  which = "column",
    gap = unit(5, "mm")
)
```




```{r}

bryozoa_map_plot <- Heatmap(
  bryozoa_mat,
  name = "Z-score",
  height = unit(nrow(bryozoa_mat) * 10, "mm"),
  col = col_fun,
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = F,
  row_names_side = "left",
  row_names_gp = gpar(fontsize = 10),
  na_col = "grey90",
  top_annotation = NULL,
  bottom_annotation = NULL,
  heatmap_legend_param = list(
    title = "Z-score",
    title_position = "topcenter",
    legend_direction = "horizontal"
  )
)

draw(bryozoa_map_plot, heatmap_legend_side = "top")

```


```{r}
# Ensure colorspace and ComplexHeatmap are loaded
library(colorspace)
library(ComplexHeatmap)

# Split matrix by data type
edna_mat_bryozoa <- bryozoa_mat[grepl("RSV", rownames(bryozoa_mat), ignore.case = TRUE), , drop = FALSE]
plankton_mat_bryozoa <- bryozoa_mat[grepl("Abundance \\(cell/L\\)", rownames(bryozoa_mat)), , drop = FALSE]
coverage_mat_bryozoa <- bryozoa_mat[grepl("Blade Coverage", rownames(bryozoa_mat)), , drop = FALSE]


# Split matrix by data type
# eDNA
col_fun_edna <- colorRamp2(
 seq(min(edna_mat_bryozoa, na.rm = TRUE), max(edna_mat_bryozoa, na.rm = TRUE), length.out = 100),
  viridis (100, option = "viridis"))

# Plankton
col_fun_plankton <- colorRamp2(
  seq(min(plankton_mat_bryozoa, na.rm = TRUE), max(plankton_mat_bryozoa, na.rm = TRUE), length.out = 100),
  viridis(100, option = "viridis")
)

# Blade coverage (still 0â€“100 range unless you want to change it)
col_fun_coverage <- colorRamp2(
  seq(min(coverage_mat_bryozoa, na.rm = TRUE), max(coverage_mat_bryozoa, na.rm = TRUE), length.out = 100),
  viridis(100, option = "viridis")
)


```

```{r}
hm_edna <- Heatmap(
  edna_mat_bryozoa,
  name = "eDNA log(RSV)",
  col = col_fun_edna,
  show_row_names = TRUE,
  show_column_names = FALSE,
  row_names_side = "left",
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  na_col = "grey90",
  top_annotation = top_anno,
  bottom_annotation = NULL,
  row_names_gp = gpar(fontsize = 10),
  heatmap_legend_param = list(title_position = "topleft", legend_direction = "vertical")#,
 # ,
#cell_fun = function(j, i, x, y, width, height, fill) {
 #   value <- edna_mat_bryozoa[i, j]
# if (!is.na(value)) {
 #     grid.text(sprintf("%.1f", value), x, y, gp = gpar(fontsize = 7, col = "red"))
  #  }
# }
)

hm_plankton <- Heatmap(
  plankton_mat_bryozoa,
  name = "Plankton (cells/L)",
  col = col_fun_plankton,
  show_row_names = TRUE,
  show_column_names = FALSE,
    row_names_side = "left",
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  na_col = "grey90",
  top_annotation = NULL,
  bottom_annotation = NULL,
  row_names_gp = gpar(fontsize = 10),
  heatmap_legend_param = list(title_position = "topleft", legend_direction = "vertical")
)

hm_coverage <- Heatmap(
  coverage_mat_bryozoa,
  name = "Blade Coverage (%)",
  col = col_fun_coverage,
  show_row_names = TRUE,
  show_column_names = FALSE,
    row_names_side = "left",
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  na_col = "grey90",
  top_annotation = NULL,
  bottom_annotation = bottom_anno,
  row_names_gp = gpar(fontsize = 10),
  heatmap_legend_param = list(title_position = "topleft", legend_direction = "vertical")
)

# Draw the composite heatmap
plot_bryo <- draw(hm_edna %v% hm_plankton %v% hm_coverage,
     heatmap_legend_side = "right",
     merge_legend = FALSE)

```


