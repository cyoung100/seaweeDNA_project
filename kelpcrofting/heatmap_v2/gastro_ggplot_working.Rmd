---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
```{r}
# 0) Libraries & global theme (no grid lines)
library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(lubridate)
library(scales)
library(patchwork)
library(janitor)
library(forcats)

theme_set(
  theme_minimal(base_size = 12) +
    theme(
      panel.grid       = element_blank(),
      axis.title       = element_text(size = 12),
      axis.text        = element_text(size = 12),
      legend.title     = element_text(size = 12),
      legend.text      = element_text(size = 12),
      strip.text       = element_text(size = 12)
    )
)

# 1) Read & compute per‐cm² abundances

gastro <- read.csv("gastro_heatmap_full.csv") %>%
  clean_names() %>%
  filter(site != "Scalpay") %>% 
  mutate(gibbula_p_cm = gibbula / for_standardizing,
         lacuna_p_cm = lacuna / for_standardizing,
        rissoa_p_cm = rissoa / for_standardizing,
        patella_p_cm = patella / for_standardizing,
         parsed_date = make_date(year, month, day)) %>% 
  select(-for_standardizing)
```

```{r}

library(tidyverse)
library(tidyverse)

gastro_longer <- gastro %>%
  pivot_longer(
    cols = -c(
      seaweed, sample_code, site, station_no,
      date, day, month, year, parsed_date, gibbula, lacuna, rissoa, patella 
    ),
    names_to  = "species_id",
    values_to = "measurement_value"
  ) %>%
  mutate(
    measurement_type = case_when(
      str_detect(species_id, "^otu_")       ~ "eDNA",
      species_id == "plankton_gastropoda"     ~ "plankton",
      str_detect(species_id, "_p_cm$")      ~ "blade",
      TRUE                                  ~ NA_character_
    ),
    measurement_origin = case_when(
      measurement_type == "eDNA"                               ~ "Plankton eDNA (RSV)",
      measurement_type == "plankton"                           ~ "Plankton Abundance (cell/L)",
      measurement_type == "blade"  ~ "Blade Abundance - (ind/cm²)",
      TRUE                                                     ~ NA_character_
    ),
    measurement_value = case_when(
      measurement_type == "eDNA" ~ sqrt(measurement_value),
      TRUE                       ~ measurement_value
    )
  ) 



gastro_longer <- gastro_longer %>%
  mutate(
    species_id = fct_recode(
      species_id,
      # eDNA OTUs:
      "Antarctoneptunea aurora"       = "otu_antarctoneptunea_aurora",
      "Assiminea grayana"            = "otu_assiminea_grayana",
      "Atlanta ariejansseni"         = "otu_atlanta_ariejansseni",
      "Bulinus nasutus"              = "otu_bulinus_nasutus",
      "Burnupia sp."                 = "otu_burnupia_sp_ugsb_25228",
      "Doto coronata)"                = "otu_doto_coronata",
      "Ercolania sp."                = "otu_ercolania_sp_kh_2011",
      "Glyptophysa sp."              = "otu_glyptophysa_sp_11_pga_2018",
      "Lacuna vincta"                = "otu_lacuna_vincta",
      "Limapontia capitata)"          = "otu_limapontia_capitata",
      "Megalovalvata piligera"       = "otu_megalovalvata_piligera",
      "Mitrella moleculina"          = "otu_mitrella_moleculina",
      "Neritina canalis"             = "otu_neritina_canalis",
      "Peringia ulvae"               = "otu_peringia_ulvae",
      "Placida dendritica"           = "otu_placida_dendritica",
      "Rissoa guernei"               = "otu_rissoa_guernei",
      "Sconsia sp."                  = "otu_sconsia_sp_mnhn_im_2013_61442",
      "Segmentina nitida"            = "otu_segmentina_nitida",
      "Siphonaria pectinata"         = "otu_siphonaria_pectinata",
      "Stenophysa marmorata"         = "otu_stenophysa_marmorata",
      "Steromphala cineraria"        = "otu_steromphala_cineraria",
      "Therasia thaisa"              = "otu_therasia_thaisa",
      "Rissoa sp." = "rissoa_p_cm",
      "Patella sp." = "patella_p_cm",
      "Lacuna sp." = "lacuna_p_cm",
      "Gibbula sp." = "gibbula_p_cm",
      "Gastropoda" = "plankton_gastropoda"
      # (you can add more here if needed)
    )
  )
library(forcats)

gastro_longer <- gastro_longer %>%
  filter(parsed_date != as.Date("2021-06-15"))



```

```{r}
# ─────────────────────────────────────────────────────────────────────────────
# 4) Factor for plotting order
# ─────────────────────────────────────────────────────────────────────────────

order_ids <- gastro_longer %>% 
  distinct(parsed_date, station_no) %>% 
  arrange(parsed_date, station_no) %>% 
  mutate(sample_order = paste(parsed_date, station_no, sep = "_")) %>% 
  pull(sample_order)

gastro_longer <- gastro_longer %>%
  mutate(
    station      = as.character(station_no),
    sample_order = factor(paste(parsed_date, station, sep = "_"),
                          levels = order_ids)
  )

# ─────────────────────────────────────────────────────────────────────────────
# 5) Prepare axis‐tick labels
# ─────────────────────────────────────────────────────────────────────────────
parts          <- strsplit(levels(gastro_longer$sample_order), "_")
dates          <- as.Date(sapply(parts, `[`, 1))
raw_stations <- sapply(parts, `[`, 2)
date_labels    <- ifelse(!duplicated(dates),
                         format(dates, "%d %b"),
                         "")

station_labels <- paste0("S", raw_stations)
# ─────────────────────────────────────────────────────────────────────────────
# 6) Split data for the four panels (blade now by seaweed)
# ─────────────────────────────────────────────────────────────────────────────

d_e      <- filter(gastro_longer, measurement_origin == "Plankton eDNA (RSV)")
d_p      <- filter(gastro_longer, measurement_origin == "Plankton Abundance (cell/L)")
d_b_sacc <- filter(gastro_longer,
                   measurement_origin == "Blade Abundance - (ind/cm²)",
                   seaweed == "Saccharina")
d_b_ala  <- filter(gastro_longer,
                   measurement_origin == "Blade Abundance - (ind/cm²)",
                   seaweed == "Alaria")

# ─────────────────────────────────────────────────────────────────────────────
# 7) Shared fill‐scales
# ─────────────────────────────────────────────────────────────────────────────

library(viridis)

scale_e <- scale_fill_viridis_c(
  option    = "magma", direction = -1,
  name      = "Meroplankton\neDNA sqrt(ASV)",
  na.value  = "grey90"
)

scale_p <- scale_fill_viridis_c(
  option    = "magma", direction = -1,
  name      = "Meroplankton\nAbundance\n(cells/L)",
  na.value  = "grey90"
)

scale_b_a <- scale_fill_viridis_c(
  option    = "magma", direction = -1,
  name      = "Alaria frond\nAbundance\n(ind/cm²)",
  na.value  = "grey90"
)

scale_b_s <- scale_fill_viridis_c(
  option    = "magma", direction = -1,
  name      = "Saccharina frond\nAbundance\n(ind/cm²)",
  na.value  = "grey90"
)

# ─────────────────────────────────────────────────────────────────────────────
# 8) Build each panel
# ─────────────────────────────────────────────────────────────────────────────

p1 <- ggplot(d_e, aes(x = as.numeric(sample_order), 
                      y = fct_rev(species_id), 
                      fill = measurement_value)) +
  geom_tile(color = NA) + scale_e +
  scale_x_continuous(
    limits = c(0.5, length(order_ids)+0.5),
    breaks = seq_along(order_ids),
    labels = NULL,
    expand = c(0,0),
    sec.axis = dup_axis(name = NULL, labels = station_labels)
  ) +
  theme(
    axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.text.x.top     = element_text(size = 10),
    axis.ticks.x.top    = element_blank(),
    axis.text.y         = element_text(size = 10),
    axis.title.x        = element_blank()
  )+ ylab("Planktonic eDNA\nRSV rel. abundance (%)") +
  theme(axis.title.y = element_text(size = 10))

p2 <- ggplot(d_p, aes(x = sample_order, y = fct_rev(species_id), fill = measurement_value)) +
  geom_tile(color = NA) + scale_p +
  theme(
    axis.text.x   = element_blank(),
    axis.ticks.x  = element_blank(),
    axis.text.y   = element_text(size = 10),
    axis.title.x  = element_blank()
  ) +
  ylab(NULL)

p3 <- ggplot(d_b_sacc, aes(x = as.numeric(sample_order),
                           y = fct_rev(species_id),
                           fill = measurement_value)) +
  geom_tile(color = NA) + scale_b_s +
  scale_x_continuous(
    limits = c(0.5, length(order_ids)+0.5),
    breaks = seq_along(order_ids),
    labels = NULL,
    expand = c(0,0)
  ) +
  theme(
    axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.text.y         = element_text(size = 10),
    axis.title.x        = element_blank()
  ) +
  ylab("Saccharina\n(ind/cm²)")

p4 <- ggplot(d_b_ala, aes(x = as.numeric(sample_order),
                          y = fct_rev(species_id),
                          fill = measurement_value)) +
  geom_tile(color = NA) + scale_b_s +
  scale_x_continuous(
    limits = c(0.5, length(order_ids)+0.5),
    breaks = seq_along(order_ids),
    labels = date_labels,
    expand = c(0,0),
    name   = "Date"
  )  + theme(
    axis.text.x.bottom  = element_text(size = 10, vjust = 3, hjust = 0),
    axis.title.x.bottom = element_text(margin = margin(t = 5)),
    axis.ticks.x        = element_blank(),
    panel.background    = element_blank(),
    panel.grid          = element_blank(),
    axis.text.y         = element_text(size = 10),
    axis.title.x        = element_blank(),
          legend.title     = element_text(size = 10),  # <- uniform legend title
      legend.text      = element_text(size = 10),
  ) +
  ylab("Alaria\n(ind/cm²)")+
  theme(axis.title.y = element_text(size = 10))

final_plot <- p1 / p2 / p3 / p4 +
  plot_layout(ncol = 1, heights = c(6,1,1,1), guides = "collect") &
  theme(
    legend.position   = "right",
    legend.title.size = 10,
    legend.text.size  = 10,
    legend.key.height = unit(0.8, "lines"),
    legend.key.width  = unit(0.8, "lines")
  )

print(final_plot)
```

```{r}

svglite::svglite(
  "Gastro_KC.svg",
  width  = 15,
  height = 8.27
)
print(final_plot)
dev.off()
```

################################


################

```{r}
# --- after your gastro_longer pipeline ---

# 1) average across stations for each date/species
gastro_by_date <- gastro_longer %>%
  group_by(
    parsed_date,
    seaweed,
    measurement_origin,
    species_id
  ) %>%
  summarise(
    measurement_value = mean(measurement_value, na.rm = TRUE),
    .groups = "drop"
  )

# 2) set up a date‐only ordering and labels
date_levels <- sort(unique(gastro_by_date$parsed_date))
date_labels <- format(date_levels, "%d %b")

gastro_by_date <- gastro_by_date %>%
  mutate(
    # numeric index for plotting
    date_idx = as.numeric(factor(parsed_date, levels = date_levels))
  )

# 3) split into the four panels again
d_e      <- filter(gastro_by_date, measurement_origin == "Plankton eDNA (RSV)")
d_p      <- filter(gastro_by_date, measurement_origin == "Plankton Abundance (cell/L)")
d_b_sacc <- filter(gastro_by_date, measurement_origin == "Blade Abundance - (ind/cm²)", seaweed == "Saccharina",
    species_id != "Corophium sp."
)
d_b_ala  <- filter(gastro_by_date, measurement_origin == "Blade Abundance - (ind/cm²)", seaweed == "Alaria",
    species_id != "Corophium sp."
)

# 4) recreate each panel, mapping x = date_idx and using the new breaks/labels
p1 <- ggplot(d_e, aes(x = date_idx, y = fct_rev(species_id), fill = measurement_value)) +
  geom_tile() + scale_e +
   scale_x_continuous(
    limits   = c(0.5, length(date_levels) + 0.5),
    breaks   = seq_along(date_levels),
    labels   = NULL,
    expand   = c(0, 0)
  ) +
  theme(
    axis.text.x.bottom  = element_blank(),
    axis.ticks.x.bottom = element_blank(),
    axis.text.y         = element_text(size = 10),
    axis.title.x        = element_blank()
  ) +
  ylab("Meroplankton\neDNA sqrt(ASV)")+ theme(axis.title.y = element_text(size = 11))

p2 <- ggplot(d_p, aes(x = date_idx, y = species_id, fill = measurement_value)) +
  geom_tile() + scale_p +
  scale_x_continuous(expand = c(0,0)) +
  theme(
    axis.text.x      = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.title.x        = element_blank(),
    axis.text.y      = element_text(size = 10)
  ) +
  ylab("Meroplankton\nAbundance\n(cells/L)")+ theme(axis.title.y = element_text(size = 11))

p3 <- ggplot(d_b_sacc, aes(x = date_idx, y = fct_rev(species_id), fill = measurement_value)) +
  geom_tile() + scale_b_s +
  scale_x_continuous(expand = c(0,0)) +
  theme(
    axis.text.x      = element_blank(),
    axis.ticks.x     = element_blank(),
    axis.title.x        = element_blank(),
    axis.text.y      = element_text(size = 10)
  ) +
  ylab("Saccharina\nfrond\nAbundance\n(ind/cm²)")+ theme(axis.title.y = element_text(size = 11))

p4 <- ggplot(d_b_ala, aes(x = date_idx, y = fct_rev(species_id), fill = measurement_value)) +
  geom_tile() + scale_b_a +
  scale_x_continuous(
    breaks = seq_along(date_levels),
    labels = date_labels,
    expand = c(0,0),
    name   = "Date"
  ) +
  theme(
    axis.text.x       = element_text(size = 10, angle = 45, hjust = 1, vjust = 1.2),
    axis.ticks.x      = element_blank(),
    axis.text.y       = element_text(size = 10)
  ) +
  ylab("Alaria frond\nAbundance\n(ind/cm²)")+ theme(axis.title.y = element_text(size = 11))

# 5) stack & print
final_plot <- p1 / p2 / p3 / p4 +
  plot_layout(ncol = 1, heights = c(9,2,2,2), guides = "collect") &
  theme(
    legend.position   = "right",
    legend.title      = element_text(size = 10),
    legend.text       = element_text(size = 10),
        legend.key.height = unit(0.8, "lines"),
    legend.key.width  = unit(0.8, "lines"),
  plot.margin         = margin(t = 1, r = 3, b = 1, l = 3)
  )

print(final_plot)

```

