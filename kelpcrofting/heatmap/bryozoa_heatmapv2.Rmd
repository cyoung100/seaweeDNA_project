HYDROZOANS
```{r}
# Load necessary packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(janitor)
library(stringr)
library(viridis)
library(scales)
library(lubridate)
library(ComplexHeatmap)
library(circlize)
library(viridis)
library(tidyverse)

# Read data
kelpcrofting_taxa <- read.csv("kelpcrofting_focal_sp_clean2.csv")

# Filter and transform hydrozoa data
hydrozoa_heatmap <- kelpcrofting_taxa %>%
  mutate(parsed_date = dmy(date)) %>%
  filter(
    str_detect(species_name, regex("bryozoa", ignore_case = TRUE)) |
       str_detect(species_id, regex("bryozoa", ignore_case = TRUE)) |
      str_detect(class, regex("bryozoa", ignore_case = TRUE)) |
      str_detect(phylum, regex("bryozoa", ignore_case = TRUE)) |
      str_detect(species_id, regex("zooplank_abundance_total_bryozoa", ignore_case = TRUE)) |
      str_detect(species_id, regex("zooplank_abundance_bryozoa", ignore_case = TRUE))
  ) %>%
  filter(!(str_detect(species_id, "total") & measurement_origin != "edna")) %>%
  filter(!is.na(measurement_value), !is.na(measurement_origin)) %>%
  mutate(
    station = paste0("st", station_no),
    sample_order = paste(parsed_date, station_no, sep = "_"),
    origin_label = factor(measurement_origin, levels = c("plankton", "edna", "blade_coverage")),
    y_axis = factor(paste("bryozoa", origin_label, sep = " | "),
                    levels = c("bryozoa | edna", "bryozoa | plankton", "bryozoa | blade"))
  ) %>%
  arrange(parsed_date, station_no)

# Deduplicate by averaging across sample_order Ã— y_axis
hydrozoa_cleaned <- hydrozoa_heatmap %>%
  group_by(y_axis, sample_order) %>%
  summarise(measurement_value = mean(measurement_value, na.rm = TRUE), .groups = "drop")

# Pivot to wide matrix and convert to matrix
hydrozoa_heatmap_mat <- hydrozoa_cleaned %>%
  filter(!is.na(y_axis)) %>%
  pivot_wider(names_from = sample_order, values_from = measurement_value, values_fill = 0) %>%
  column_to_rownames("y_axis") %>%
  as.matrix()

# Z-score scaling
hydrozoa_mat_scaled <- t(scale(t(hydrozoa_heatmap_mat)))

# Color scale using viridis magma
viridis_magma <- viridis(100, option = "M")
value_range <- range(hydrozoa_mat_scaled, na.rm = TRUE)
col_fun <- colorRamp2(seq(value_range[1], value_range[2], length.out = 100), viridis_magma)
```


```{r}
# Build annotation: station below, date above
hydro_sample_meta <- hydrozoa_heatmap %>%
  select(sample_order, parsed_date, station_no) %>%
  distinct() %>%
  arrange(parsed_date, station_no)

station_labels <- paste("S", hydro_sample_meta$station_no)
date_labels <- format(hydro_sample_meta$parsed_date, "%b %d")
date_label_vector <- rep("", length(date_labels))
date_label_vector[seq(2, length(date_labels), by = 3)] <- date_labels[seq(2, length(date_labels), by = 3)]

hydro_top_anno <- HeatmapAnnotation(
  Date = anno_text(date_label_vector, rot = 0, gp = gpar(fontsize = 8)),
  Station = anno_text(station_labels, rot = 90, gp = gpar(fontsize = 6)),
  annotation_name_side = "left",
  annotation_height = unit(c(1, 2), "lines")
)
# Extract metadata from column names
col_meta <- strsplit(colnames(hydrozoa_mat_scaled), "_")
dates <- sapply(col_meta, `[`, 1)
stations <- paste0("S", sapply(col_meta, `[`, 2))  # Add S prefix

# Format dates
formatted_dates <- format(as.Date(dates), "%b %d")

# Blank out most dates (e.g., every 3rd one only)
sparse_date_labels <- rep("", length(formatted_dates))
sparse_date_labels[seq(2, length(formatted_dates), by = 3)] <- formatted_dates[seq(2, length(formatted_dates), by = 3)]
```


```{r}


# Create annotations
top_anno <- HeatmapAnnotation(
  Station = anno_text(stations, rot = 0,  just = "center", gp = gpar(fontsize = 10)),
  annotation_name_side = "left",
  annotation_height = unit(0.5, "lines"),
  which = "column"
)

bottom_anno <- HeatmapAnnotation(
  Date = anno_text(sparse_date_labels, rot = 0,  just = c("top", "right"), gp = gpar(fontsize =10)),
  annotation_name_side = "left",
  annotation_height = unit(1, "lines"),
  which = "column",
    gap = unit(5, "mm")
)

# Extract row split groups from rownames
row_groups <- case_when(
  grepl("edna", rownames(hydrozoa_mat_scaled), ignore.case = TRUE) ~ "OTU",
  grepl("plankton", rownames(hydrozoa_mat_scaled), ignore.case = TRUE) ~ "Plankton",
  grepl("blade", rownames(hydrozoa_mat_scaled), ignore.case = TRUE) ~ "Blade coverage",
  TRUE ~ "Other"
)
row_groups <- factor(row_groups, levels = c("OTU", "Plankton", "Blade coverage"))

```


```{r}

# Final heatmap
hydro_heatmap_obj <- Heatmap(
  hydrozoa_mat_scaled,
  name = "Z-score",
  row_split = row_groups,
  col = col_fun,
  na_col = "grey90",
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_row_names = F,
  show_column_names = FALSE,
  top_annotation = top_anno,
  bottom_annotation = bottom_anno,
  row_names_gp = gpar(fontsize = 10),
  heatmap_legend_param = list(title = "Z - Score")
)

# Draw it
draw(hydro_heatmap_obj)
```



# Build annotation: station below, date above
sample_meta <- hydrozoa_heatmap %>%
  select(sample_order, parsed_date, station_no) %>%
  distinct() %>%
  arrange(parsed_date, station_no)

station_labels <- paste("St", sample_meta$station_no)
date_labels <- format(sample_meta$parsed_date, "%b %d")
date_label_vector <- rep("", length(date_labels))
date_label_vector[seq(2, length(date_labels), by = 3)] <- date_labels[seq(2, length(date_labels), by = 3)]

top_anno <- HeatmapAnnotation(
  Date = anno_text(date_label_vector, rot = 0, gp = gpar(fontsize = 8)),
  Station = anno_text(station_labels, rot = 90, gp = gpar(fontsize = 6)),
  annotation_name_side = "left",
  annotation_height = unit(c(1, 2), "lines")
)

# Draw heatmap
hydrozoa_heatmap_obj <- Heatmap(
  mat_scaled,
  name = "Z-score",
  col = col_fun,
  na_col = "grey90",
  cluster_rows = FALSE,
  cluster_columns = FALSE,
  show_row_names = TRUE,
  show_column_names = FALSE,
  top_annotation = top_anno,
  row_names_gp = gpar(fontsize = 10),
  heatmap_legend_param = list(title = "Z-score")
)

# Export high-quality PDF
pdf("hydrozoa_heatmap.pdf", width = 10, height = 6)
draw(heatmap_obj)
dev.off()

hydrozoa_heatmap_obj

```

```{r}
library(dplyr)
library(tidyr)
library(stringr)

find_unique_hydro_mentions <- function(df) {
  # 1. Column names containing "hydro"
  hydro_cols <- names(df)[str_detect(names(df), regex("hydro", ignore_case = TRUE))]

  # 2. Unique cell values containing "hydro"
  hydro_cells <- df %>%
    mutate(across(everything(), as.character)) %>%
    pivot_longer(everything(), names_to = "column", values_to = "value") %>%
    filter(str_detect(value, regex("hydro", ignore_case = TRUE))) %>%
    distinct(value) %>%
    pull(value)

  list(
    column_names = unique(hydro_cols),
    cell_values = unique(hydro_cells)
  )
}

# Example usage
unique_hydro_mentions <- find_unique_hydro_mentions(kelpcrofting_taxa)

# View results
unique_hydro_mentions$column_names
unique_hydro_mentions$cell_values

```




